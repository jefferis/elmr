<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Making surface meshes • elmr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Making surface meshes">
<meta property="og:description" content="elmr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">elmr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/articles/multiple_somata.html">Finding Neurons with Multiple Somata</a>
    </li>
    <li>
      <a href="../articles/landmarks.html">Landmarks defining transforms</a>
    </li>
    <li>
      <a href="../articles/making_meshes.html">Making Surface Meshes</a>
    </li>
    <li>
      <a href="../articles/selecting_random_synapses.html">Selecting random synapses</a>
    </li>
    <li>
      <a href="../articles/xform_brain.html">Transforming from FAFB to other templates</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li>
  <a href="../SUPPORT.html">Help</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://natverse.github.io">natverse</a>
</li>
<li>
  <a href="https://github.com/natverse/elmr">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Making surface meshes</h1>
                        <h4 class="author">Gregory Jefferis</h4>
            
            <h4 class="date">2020-06-08</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/natverse/elmr/blob/master/vignettes/making_meshes.Rmd"><code>vignettes/making_meshes.Rmd</code></a></small>
      <div class="hidden name"><code>making_meshes.Rmd</code></div>

    </div>

    
    
<div id="intro" class="section level2">
<h2 class="hasAnchor">
<a href="#intro" class="anchor"></a>Intro</h2>
<p>You can use 3D data pulled from CATMAID to create meshes. You can also do the same with light level data and then transform into FAFB space.</p>
<div id="setup" class="section level3">
<h3 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h3>
<p>First load main packages</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">elmr</span>)
<span class="no">cl</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/try.html">try</a></span>(<span class="fu">catmaid_login</span>())
<span class="no">catmaid_available</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span>(<span class="no">cl</span>, <span class="st">"catmaid_connection"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">knitr</span>)
<span class="no">opts_chunk</span>$<span class="fu">set</span>(<span class="kw">eval</span><span class="kw">=</span><span class="no">catmaid_available</span>)</pre></body></html></div>
<p>In order to run some of this example we need to ensure that we:</p>
<ul>
<li>can login to the FAFB CATMAID server</li>
</ul>
<p>We will most our examples run conditionally based on this.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">alphashape3d</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rgl</span>)
<span class="co"># set up for 3d plots based on rgl package</span>
<span class="kw pkg">rgl</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgl/man/hook_rgl.html">setupKnitr</a></span>()
<span class="co"># frontal view</span>
<span class="fu"><a href="https://rdrr.io/pkg/rgl/man/viewpoint.html">view3d</a></span>(<span class="kw">userMatrix</span><span class="kw">=</span><span class="kw pkg">rgl</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgl/man/matrices.html">rotationMatrix</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="no">pi</span>, <span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>), <span class="kw">zoom</span><span class="kw">=</span><span class="fl">0.8</span>)</pre></body></html></div>
</div>
</div>
<div id="selecting-synapses" class="section level2">
<h2 class="hasAnchor">
<a href="#selecting-synapses" class="anchor"></a>Selecting synapses</h2>
<p>We’re going to use synapses between PNs and KCs to define a mesh</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">pntokc</span> <span class="kw">=</span> <span class="fu">catmaid_get_connectors_between</span>(<span class="kw">pre_skids</span> <span class="kw">=</span> <span class="st">'PN'</span>,
                                        <span class="kw">post_skids</span> <span class="kw">=</span> <span class="st">'KC'</span>)
<span class="co"># select 3d position of presynaptic connectors</span>
<span class="no">pntokc</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>(<span class="no">connector_id</span>, <span class="kw">.keep_all</span><span class="kw">=</span><span class="fl">TRUE</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">connector_x</span>:<span class="no">connector_z</span>) <span class="kw">%&gt;%</span>
  <span class="no">data.matrix</span> <span class="kw">-&gt;</span> <span class="no">cxyz</span></pre></body></html></div>
<p>Now we can make an alphashape based on those connector positions. We need to set the alpha value in the ashape3d function to something sensible based on the spatial scale of our data - he we use alpha=6000 nm.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">calyx.a</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/alphashape3d/man/ashape3d.html">ashape3d</a></span>(<span class="no">cxyz</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">6000</span>)
<span class="no">calyx</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/rgl/man/as.mesh3d.default.html">as.mesh3d</a></span>(<span class="no">calyx.a</span>)</pre></body></html></div>
<p>We can compare the resultant mesh with the location of the connectors</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/rgl/man/mesh3d.html">wire3d</a></span>(<span class="no">calyx</span>)
<span class="fu"><a href="https://rdrr.io/pkg/rgl/man/3dobjects.html">points3d</a></span>(<span class="no">cxyz</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">'red'</span>)
<span class="fu"><a href="https://rdrr.io/pkg/rgl/man/3dobjects.html">points3d</a></span>(<span class="no">pntokc</span>[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'post_node_x'</span>,<span class="st">'post_node_y'</span>,<span class="st">'post_node_z'</span>)], <span class="kw">col</span><span class="kw">=</span><span class="st">'blue'</span>)</pre></body></html></div>
<p><img src="making_meshes_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>We can also compare with the mesh supplied with elmr, which was transformed from JFRC2 space via JFRC2013 to FAFB:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/rgl/man/mesh3d.html">wire3d</a></span>(<span class="no">calyx</span>)
<span class="fu"><a href="https://rdrr.io/pkg/rgl/man/plot3d.html">plot3d</a></span>(<span class="no">FAFBNP.surf</span>, <span class="st">"MB_CA_R"</span>, <span class="kw">alpha</span><span class="kw">=</span><span class="fl">.3</span>)
<span class="fu"><a href="https://rdrr.io/pkg/rgl/man/viewpoint.html">view3d</a></span>(<span class="kw">userMatrix</span><span class="kw">=</span><span class="kw pkg">rgl</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgl/man/matrices.html">rotationMatrix</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="no">pi</span>, <span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>), <span class="kw">zoom</span><span class="kw">=</span><span class="fl">0.8</span>)</pre></body></html></div>
<p><img src="making_meshes_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>And we can also compare the dorsal view as well:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/rgl/man/mesh3d.html">wire3d</a></span>(<span class="no">calyx</span>)
<span class="fu"><a href="https://rdrr.io/pkg/rgl/man/plot3d.html">plot3d</a></span>(<span class="no">FAFBNP.surf</span>, <span class="st">"MB_CA_R"</span>, <span class="kw">alpha</span><span class="kw">=</span><span class="fl">.3</span>)
<span class="fu"><a href="https://rdrr.io/pkg/rgl/man/viewpoint.html">view3d</a></span>(<span class="kw">userMatrix</span><span class="kw">=</span><span class="kw pkg">rgl</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgl/man/matrices.html">rotationMatrix</a></span>(<span class="kw">angle</span> <span class="kw">=</span> -<span class="no">pi</span>/<span class="fl">2</span>, <span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>), <span class="kw">zoom</span><span class="kw">=</span><span class="fl">0.8</span>)</pre></body></html></div>
<p><img src="making_meshes_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>It’s clear that there is a mismatch here. This may originate in part from the fact that the JFRC2013 intermediate template has rather flattened MB calyces. The quality of the JFRC2-JFRC2013 bridging registration is likely also a factor.</p>
<p>Finally if one wanted to place this mesh into CATMAID, one could do it as follows:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu">catmaid_add_volume</span>(<span class="no">calyx</span>, <span class="kw">title</span><span class="kw">=</span><span class="st">"fafb14.pn-kc.MB_CA_R"</span>,
                   <span class="kw">comment</span><span class="kw">=</span><span class="st">"Constructed by GSXEJ from PN-KC synapses directly in FAFB14 space."</span>)</pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Gregory Jefferis.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '9af2dfacacefe7a9e5431ffc3dbefbba',
    indexName: 'elmr',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
